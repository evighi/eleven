datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum TipoUsuario {
  CLIENTE
  ADMIN_MASTER
  ADMIN_ATENDENTE
  ADMIN_PROFESSORES
  CLIENTE_APOIADO // üëà NOVO
}

// ‚úÖ NOVO: "features" (op√ß√µes limitadas) que o ADMIN_MASTER pode ligar/desligar pro ADMIN_ATENDENTE.
// Isso vira base pro menu hamburger e tamb√©m pro bloqueio real nas rotas.
enum AtendenteFeature {
  ATD_AGENDAMENTOS
  ATD_PERMANENTES
  ATD_CHURRAS
  ATD_BLOQUEIOS
  ATD_USUARIOS_LEITURA
  ATD_USUARIOS_EDICAO
  ATD_RELATORIOS
}

enum StatusAgendamento {
  CONFIRMADO
  CANCELADO
  FINALIZADO
  TRANSFERIDO
}

enum TipoCamera {
  COM_CAMERA
  SEM_CAMERA
}

enum DiaSemana {
  DOMINGO
  SEGUNDA
  TERCA
  QUARTA
  QUINTA
  SEXTA
  SABADO
}

enum Turno {
  DIA
  NOITE
}

enum DeletionStatus {
  PENDING // aguardando janela de 90 dias
  DONE // exclus√£o conclu√≠da
  CANCELLED // cancelado pelo admin
}

enum InteractionType {
  AG_COMUM
  AG_PERM
  CHURRAS
  NONE // caso n√£o haja intera√ß√£o conhecida
}

/// üëá Diferencia√ß√£o de sess√µes de professor (mantido)
enum TipoSessaoProfessor {
  AULA
  JOGO
}

/**
 * ============================================================================
 * üîî NOTIFICA√á√ïES (IN-APP)
 * - Notification: uma notifica√ß√£o ‚Äúglobal‚Äù criada pelo sistema/ator
 * - NotificationRecipient: status por usu√°rio (lida/n√£o lida por admin)
 * ==========================================================================
 */

enum NotificationType {
  AGENDAMENTO_COMUM_CRIADO
  AGENDAMENTO_COMUM_CANCELADO
  BLOQUEIO_QUADRA_CRIADO
  BLOQUEIO_QUADRA_REMOVIDO

  // ‚úÖ j√° fica no schema (implementar depois)
  AGENDAMENTO_PERMANENTE_EXCECAO
  AGENDAMENTO_CHURRASQUEIRA_CRIADO
  AGENDAMENTO_CHURRASQUEIRA_CANCELADO
  AGENDAMENTO_CHURRASQUEIRA_PERMANENTE_EXCECAO
}

model Notification {
  id        String           @id @default(uuid())
  type      NotificationType
  title     String
  message   String
  data      Json?
  createdAt DateTime         @default(now())

  // (opcional) quem gerou
  actorId String?
  actor   Usuario? @relation("NotificationActor", fields: [actorId], references: [id])

  recipients NotificationRecipient[]

  @@index([createdAt])
  @@index([type])
  @@index([actorId])
}

model NotificationRecipient {
  id             String    @id @default(uuid())
  notificationId String
  userId         String
  readAt         DateTime?

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user         Usuario      @relation("NotificationRecipientUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([notificationId, userId])
  @@index([userId, readAt])
}

/**
 * ========================================================================
 */

model Usuario {
  id                String      @id @default(uuid())
  nome              String
  email             String      @unique
  celular           String?
  senha             String
  cpf               String?
  nascimento        DateTime?
  tipo              TipoUsuario
  verificado        Boolean     @default(false)
  codigoEmail       String?
  codigoRecuperacao String?
  expiraEm          DateTime?

  // üí∞ valor por aula do professor (opcional)
  valorQuadra Decimal? @db.Decimal(10, 2)

  // üëá NOVO: controles de apoio (benef√≠cio de isen√ß√£o)
  apoioAtivo          Boolean @default(false) // habilita/desabilita benef√≠cio para CLIENTE_APOIADO
  apoioMensalMaxAulas Int? // limite de isen√ß√µes/m√™s (null = ilimitado)
  apoioObs            String? // observa√ß√µes internas

  agendamentos                        Agendamento[]                        @relation("AgendamentoFeitoPor")
  agendamentosPermanentes             AgendamentoPermanente[]
  participaDeAgendamentos             Agendamento[]                        @relation("JogadoresNoAgendamento")
  agendamentosChurrasqueira           AgendamentoChurrasqueira[]           @relation("UsuarioAgendamentoChurrasqueira")
  agendamentosPermanenteChurrasqueira AgendamentoPermanenteChurrasqueira[] @relation("UsuarioAgendamentoPermanenteChurrasqueira")

  agendamentosCancelados                          Agendamento[]                        @relation("AgendamentoCanceladoPor")
  permanentesCancelamentosCriados                 AgendamentoPermanenteCancelamento[]  @relation("UsuarioCriouCancelamentoPermanente")
  agendamentosTransferidos                        Agendamento[]                        @relation("AgendamentoTransferidoPor")
  agendamentosPermanentesCancelados               AgendamentoPermanente[]              @relation("AgendamentoPermanenteCanceladoPor")
  agendamentosPermanentesTransferidos             AgendamentoPermanente[]              @relation("AgendamentoPermanenteTransferidoPor")
  agendamentosChurrasqueiraCancelados             AgendamentoChurrasqueira[]           @relation("AgendamentoChurrasqueiraCanceladoPor")
  agendamentosChurrasqueiraTransferidos           AgendamentoChurrasqueira[]           @relation("AgendamentoChurrasqueiraTransferidoPor")
  agendamentosPermanenteChurrasqueiraCancelados   AgendamentoPermanenteChurrasqueira[] @relation("AgendamentoPermanenteChurrasqueiraCanceladoPor")
  agendamentosPermanenteChurrasqueiraTransferidos AgendamentoPermanenteChurrasqueira[] @relation("AgendamentoPermanenteChurrasqueiraTransferidoPor")

  permanentesChurrasqueiraCancelamentosCriados AgendamentoPermanenteChurrasqueiraCancelamento[] @relation("UsuarioCriouCancelamentoPermanenteChurrasqueira")

  bloqueiosFeitos BloqueioQuadra[] @relation("UsuarioBloqueios")

  // üëá NOVO: rela√ß√£o com multas anuladas
  multasAnuladas Agendamento[] @relation("MultaAnuladaPor")

  auditLogs AuditLog[] @relation("UsuarioAuditLogs")

  // üîî NOTIFICA√á√ïES
  notificationsSent     Notification[]          @relation("NotificationActor")
  notificationsReceived NotificationRecipient[] @relation("NotificationRecipientUser")

  // üîí controle de acesso e marca√ß√µes de exclus√£o
  disabledAt  DateTime? // bloqueia login enquanto pendente
  deletedAt   DateTime? // marca remo√ß√£o l√≥gica (se usar soft delete)
  deletedById String? // quem concluiu a exclus√£o (mantido sem FK)

  // rela√ß√µes com a fila de exclus√£o
  deletionQueue      UserDeletionQueue?  @relation("DeletionTargetUser")
  deletionsRequested UserDeletionQueue[] @relation("DeletionRequestedBy")

  // üëá rela√ß√µes como PROFESSOR nos agendamentos
  agendamentosComoProfessor            Agendamento[]           @relation("ProfessorNosAgendamentos")
  agendamentosPermanentesComoProfessor AgendamentoPermanente[] @relation("ProfessorNosPermanentes")

  // üëá NOVO: rela√ß√£o inversa ‚Äî agendamentos nos quais o usu√°rio foi o APOIADO isento
  agendamentosIsentosComoApoiado Agendamento[] @relation("ApoiadoNosAgendamentos")

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  permissoesAtendentes PermissoesAtendente[]

  @@index([disabledAt])
  @@index([deletedAt])
}

model Esporte {
  id     String  @id @default(uuid())
  nome   String  @unique
  imagem String?

  quadraEsportes          QuadraEsporte[]
  agendamentos            Agendamento[]
  agendamentosPermanentes AgendamentoPermanente[]

  /// üëá NOVO: janelas configur√°veis por esporte
  janelasAula EsporteJanelaAula[]
}

/// üëá NOVO MODEL: Janela de hor√°rios para AULA/JOGO por esporte.
model EsporteJanelaAula {
  id String @id @default(uuid())

  esporteId String
  esporte   Esporte @relation(fields: [esporteId], references: [id])

  diaSemana  DiaSemana? // null = regra padr√£o para todos os dias
  tipoSessao TipoSessaoProfessor @default(AULA)

  inicioHHMM String // ex.: "07:00"
  fimHHMM    String // ex.: "19:00"

  ativo Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([esporteId, diaSemana, tipoSessao], map: "uniq_janela_esporte_dia_tipo")
  @@index([esporteId, diaSemana, tipoSessao])
}

model Quadra {
  id         String     @id @default(uuid())
  nome       String
  numero     Int
  tipoCamera TipoCamera
  imagem     String?

  quadraEsportes          QuadraEsporte[]
  agendamentos            Agendamento[]
  agendamentosPermanentes AgendamentoPermanente[]

  bloqueios BloqueioQuadra[] @relation("QuadrasNoBloqueio")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model QuadraEsporte {
  quadraId  String
  esporteId String

  quadra  Quadra  @relation(fields: [quadraId], references: [id])
  esporte Esporte @relation(fields: [esporteId], references: [id])

  @@id([quadraId, esporteId])
  @@index([esporteId])
}

model Churrasqueira {
  id         String  @id @default(uuid())
  nome       String
  numero     Int
  imagem     String?
  observacao String?

  agendamentos            AgendamentoChurrasqueira[]
  agendamentosPermanentes AgendamentoPermanenteChurrasqueira[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Agendamento {
  id      String   @id @default(uuid())
  data    DateTime
  horario String

  usuario   Usuario @relation("AgendamentoFeitoPor", fields: [usuarioId], references: [id])
  usuarioId String

  quadra   Quadra @relation(fields: [quadraId], references: [id])
  quadraId String

  esporte   Esporte @relation(fields: [esporteId], references: [id])
  esporteId String

  jogadores Usuario[] @relation("JogadoresNoAgendamento")

  obs String?

  status StatusAgendamento @default(CONFIRMADO)

  canceladoPor   Usuario? @relation("AgendamentoCanceladoPor", fields: [canceladoPorId], references: [id])
  canceladoPorId String?

  transferidoPor   Usuario? @relation("AgendamentoTransferidoPor", fields: [transferidoPorId], references: [id])
  transferidoPorId String?

  // üëá professor e sess√£o
  professorId String?
  professor   Usuario?             @relation("ProfessorNosAgendamentos", fields: [professorId], references: [id])
  tipoSessao  TipoSessaoProfessor? @default(AULA)

  /// üëá NOVO: isen√ß√£o para CLIENTE_APOIADO
  isencaoApoiado   Boolean  @default(false)
  apoiadoUsuarioId String?
  apoiadoUsuario   Usuario? @relation("ApoiadoNosAgendamentos", fields: [apoiadoUsuarioId], references: [id])

  /// üëá NOVO: valor efetivamente cobrado (p√≥s-isenc√£o/descontos)
  valorQuadraCobrado Decimal? @db.Decimal(10, 2)

  /// Valor de multa (existente; mantido opcional)
  multa Decimal? @db.Decimal(10, 2)

  /// üëá NOVOS CAMPOS: controle de anula√ß√£o de multa
  multaAnulada      Boolean   @default(false)
  multaAnuladaEm    DateTime?
  multaAnuladaPorId String?
  multaAnuladaPor   Usuario?  @relation("MultaAnuladaPor", fields: [multaAnuladaPorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([usuarioId])
  @@index([quadraId, data])
  @@index([professorId, tipoSessao, data])
  @@index([apoiadoUsuarioId, data])
  @@index([quadraId, data, horario])
  @@index([data, status])
}

model AgendamentoPermanente {
  id        String    @id @default(uuid())
  diaSemana DiaSemana
  horario   String

  quadra   Quadra @relation(fields: [quadraId], references: [id])
  quadraId String

  usuario   Usuario @relation(fields: [usuarioId], references: [id])
  usuarioId String

  esporte   Esporte @relation(fields: [esporteId], references: [id])
  esporteId String

  dataInicio DateTime?

  status StatusAgendamento @default(CONFIRMADO)

  canceladoPor   Usuario? @relation("AgendamentoPermanenteCanceladoPor", fields: [canceladoPorId], references: [id])
  canceladoPorId String?

  transferidoPor   Usuario? @relation("AgendamentoPermanenteTransferidoPor", fields: [transferidoPorId], references: [id])
  transferidoPorId String?

  // exce√ß√µes por data (cancelar s√≥ um dia) ‚Äî QUADRA
  cancelamentos AgendamentoPermanenteCancelamento[]

  // professor e sess√£o (tamb√©m nos permanentes)
  professorId String?
  professor   Usuario?             @relation("ProfessorNosPermanentes", fields: [professorId], references: [id])
  tipoSessao  TipoSessaoProfessor? @default(AULA)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([usuarioId])
  @@index([quadraId, diaSemana, horario])
  @@index([professorId, tipoSessao, diaSemana])
  @@index([diaSemana, status])
}

model AgendamentoChurrasqueira {
  id String @id @default(uuid())

  // comum por data (mant√©m Turno)
  data  DateTime
  turno Turno

  churrasqueira   Churrasqueira @relation(fields: [churrasqueiraId], references: [id])
  churrasqueiraId String

  usuario   Usuario @relation("UsuarioAgendamentoChurrasqueira", fields: [usuarioId], references: [id])
  usuarioId String

  status StatusAgendamento @default(CONFIRMADO)

  canceladoPor   Usuario? @relation("AgendamentoChurrasqueiraCanceladoPor", fields: [canceladoPorId], references: [id])
  canceladoPorId String?

  transferidoPor   Usuario? @relation("AgendamentoChurrasqueiraTransferidoPor", fields: [transferidoPorId], references: [id])
  transferidoPorId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([usuarioId])
  @@index([churrasqueiraId, data])
  @@index([churrasqueiraId, data, turno])
}

model AgendamentoPermanenteChurrasqueira {
  id         String    @id @default(uuid())
  diaSemana  DiaSemana
  turno      Turno
  dataInicio DateTime?

  churrasqueira   Churrasqueira @relation(fields: [churrasqueiraId], references: [id])
  churrasqueiraId String

  usuario   Usuario @relation("UsuarioAgendamentoPermanenteChurrasqueira", fields: [usuarioId], references: [id])
  usuarioId String

  status StatusAgendamento @default(CONFIRMADO)

  canceladoPor   Usuario? @relation("AgendamentoPermanenteChurrasqueiraCanceladoPor", fields: [canceladoPorId], references: [id])
  canceladoPorId String?

  transferidoPor   Usuario? @relation("AgendamentoPermanenteChurrasqueiraTransferidoPor", fields: [transferidoPorId], references: [id])
  transferidoPorId String?

  // NOVO: exce√ß√µes por data (um dia cancelado na recorr√™ncia) ‚Äî CHURRASQUEIRA
  cancelamentos AgendamentoPermanenteChurrasqueiraCancelamento[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ‚úÖ remove UNIQUE global, e mant√©m s√≥ um √≠ndice normal pra performance.
  // O "√∫nico por slot" vai virar UNIQUE PARCIAL na migration SQL (Postgres).
  @@index([churrasqueiraId, diaSemana, turno], map: "idx_perm_churra_slot")
}

//
// üîπ NOVO MODEL: motivos de bloqueio de quadras
//
model MotivoBloqueio {
  id        String  @id @default(uuid())
  nome      String  @unique // ex.: "Manuten√ß√£o", "Torneio"
  descricao String?
  ativo     Boolean @default(true)

  // rela√ß√£o inversa: bloqueios que usam este motivo
  bloqueios BloqueioQuadra[] @relation("MotivoNoBloqueio")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Nova model para bloquear quadras por dia e hor√°rio
model BloqueioQuadra {
  id           String   @id @default(uuid())
  dataBloqueio DateTime

  inicioBloqueio String // ex: "09:00"
  fimBloqueio    String // ex: "22:00"

  quadras Quadra[] @relation("QuadrasNoBloqueio")

  bloqueadoPor   Usuario @relation("UsuarioBloqueios", fields: [bloqueadoPorId], references: [id])
  bloqueadoPorId String

  // üëá NOVO: motivo opcional (palavra-chave cadastrada)
  motivoId String?
  motivo   MotivoBloqueio? @relation("MotivoNoBloqueio", fields: [motivoId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// √≠ndice para buscas por bloqueios em um dia/intervalo
  @@index([dataBloqueio])
  /// √≠ndice auxiliar por motivo (ex.: relat√≥rios por motivo)
  @@index([motivoId])
}

// Exce√ß√£o (um dia) ‚Äî QUADRA
model AgendamentoPermanenteCancelamento {
  id                      String   @id @default(uuid())
  agendamentoPermanenteId String
  data                    DateTime
  motivo                  String?
  criadoPorId             String?
  createdAt               DateTime @default(now())

  permanente AgendamentoPermanente @relation(fields: [agendamentoPermanenteId], references: [id], onDelete: Cascade)
  criadoPor  Usuario?              @relation("UsuarioCriouCancelamentoPermanente", fields: [criadoPorId], references: [id])

  @@unique([agendamentoPermanenteId, data])
  @@index([agendamentoPermanenteId, data])
}

// NOVO: Exce√ß√£o (um dia) ‚Äî CHURRASQUEIRA
model AgendamentoPermanenteChurrasqueiraCancelamento {
  id                                   String   @id @default(uuid())
  agendamentoPermanenteChurrasqueiraId String
  data                                 DateTime
  motivo                               String?
  criadoPorId                          String?
  createdAt                            DateTime @default(now())

  permanente AgendamentoPermanenteChurrasqueira @relation(fields: [agendamentoPermanenteChurrasqueiraId], references: [id], onDelete: Cascade)
  criadoPor  Usuario?                           @relation("UsuarioCriouCancelamentoPermanenteChurrasqueira", fields: [criadoPorId], references: [id])

  @@unique([agendamentoPermanenteChurrasqueiraId, data])
  @@index([agendamentoPermanenteChurrasqueiraId, data])
}

model ConfiguracaoSistema {
  id               Int     @id
  valorMultaPadrao Decimal @db.Decimal(10, 2)

  // =========================================================
  // ‚úÖ NOVO: Regra global para "AULA ap√≥s hor√°rio" (aula extra)
  // - Edit√°vel pelo ADMIN_MASTER
  // - O valor final SEMPRE √© salvo em Agendamento.valorQuadraCobrado
  // =========================================================
  aulaExtraAtiva      Boolean @default(true)
  aulaExtraInicioHHMM String  @default("18:00") // corte
  aulaExtraFimHHMM    String  @default("23:00") // [inicio, fim) - padr√£o do teu c√≥digo
  valorAulaExtra      Decimal @default(50.00) @db.Decimal(10, 2)
}

// ‚úÖ NOVO: Config global (singleton) das permiss√µes do ADMIN_ATENDENTE.
// A ideia √© ter SEMPRE 1 linha (id=1). O ADMIN_MASTER edita essa lista.
model PermissoesAtendente {
  id Int @id @default(1)

  // lista de "features" liberadas pro atendente
  features AtendenteFeature[] @default([])

  // quem alterou por √∫ltimo (opcional)
  updatedById String?
  updatedBy   Usuario? @relation(fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([updatedById])
}

// =====================
// AUDITORIA
// =====================

enum AuditTargetType {
  USUARIO
  AGENDAMENTO
  AGENDAMENTO_PERMANENTE
  AGENDAMENTO_CHURRASQUEIRA
  AGENDAMENTO_PERMANENTE_CHURRASQUEIRA
  QUADRA
  CHURRASQUEIRA
  SISTEMA
}

model AuditLog {
  id String @id @default(uuid())

  // Quem fez (pode ser null em a√ß√µes an√¥nimas)
  actorId   String?
  actor     Usuario?     @relation("UsuarioAuditLogs", fields: [actorId], references: [id])
  actorName String? // snapshot do nome no momento do evento
  actorTipo TipoUsuario? // snapshot do tipo no momento do evento

  // O que aconteceu
  event String // ex.: "LOGIN_SUCESSO", "AGENDAMENTO_CREATE", etc.

  // Contra quem/qual recurso
  targetType AuditTargetType
  targetId   String? // id do recurso; pode ser null em eventos gerais

  // Contexto
  ip        String?
  userAgent String?
  metadata  Json?

  createdAt DateTime @default(now())

  @@index([event])
  @@index([actorId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

model UserDeletionQueue {
  id String @id @default(uuid())

  // Usu√°rio alvo (1:1)
  usuarioId String  @unique
  usuario   Usuario @relation("DeletionTargetUser", fields: [usuarioId], references: [id])

  // Quem solicitou (opcional)
  requestedById String?
  requestedBy   Usuario? @relation("DeletionRequestedBy", fields: [requestedById], references: [id])

  status DeletionStatus @default(PENDING)

  // √öltima intera√ß√£o para exibir no front
  lastInteractionType InteractionType @default(NONE)
  lastInteractionId   String?
  lastInteractionDate DateTime?

  // Data a partir da qual pode excluir (ex.: lastInteractionDate + 90d)
  eligibleAt DateTime?

  // Auditoria da fila
  requestedAt DateTime  @default(now())
  processedAt DateTime?
  cancelledAt DateTime?
  attempts    Int       @default(0)
  reason      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, eligibleAt])
  @@index([requestedAt])
}
