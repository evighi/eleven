datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum TipoUsuario {
  CLIENTE
  ADMIN_MASTER
  ADMIN_ATENDENTE
  ADMIN_PROFESSORES
  CLIENTE_APOIADO // ðŸ‘ˆ NOVO
}

// âœ… NOVO: "features" (opÃ§Ãµes limitadas) que o ADMIN_MASTER pode ligar/desligar pro ADMIN_ATENDENTE.
// Isso vira base pro menu hamburger e tambÃ©m pro bloqueio real nas rotas.
enum AtendenteFeature {
  ATD_AGENDAMENTOS
  ATD_PERMANENTES
  ATD_CHURRAS
  ATD_BLOQUEIOS
  ATD_USUARIOS_LEITURA
  ATD_USUARIOS_EDICAO
  ATD_RELATORIOS
}

enum StatusAgendamento {
  CONFIRMADO
  CANCELADO
  FINALIZADO
  TRANSFERIDO
}

enum TipoCamera {
  COM_CAMERA
  SEM_CAMERA
}

enum DiaSemana {
  DOMINGO
  SEGUNDA
  TERCA
  QUARTA
  QUINTA
  SEXTA
  SABADO
}

enum Turno {
  DIA
  NOITE
}

enum DeletionStatus {
  PENDING // aguardando janela de 90 dias
  DONE // exclusÃ£o concluÃ­da
  CANCELLED // cancelado pelo admin
}

enum InteractionType {
  AG_COMUM
  AG_PERM
  CHURRAS
  NONE // caso nÃ£o haja interaÃ§Ã£o conhecida
}

/// ðŸ‘‡ DiferenciaÃ§Ã£o de sessÃµes de professor (mantido)
enum TipoSessaoProfessor {
  AULA
  JOGO
}

model Usuario {
  id                String      @id @default(uuid())
  nome              String
  email             String      @unique
  celular           String?
  senha             String
  cpf               String?
  nascimento        DateTime?
  tipo              TipoUsuario
  verificado        Boolean     @default(false)
  codigoEmail       String?
  codigoRecuperacao String?
  expiraEm          DateTime?

  // ðŸ’° valor por aula do professor (opcional)
  valorQuadra Decimal? @db.Decimal(10, 2)

  // ðŸ‘‡ NOVO: controles de apoio (benefÃ­cio de isenÃ§Ã£o)
  apoioAtivo          Boolean @default(false) // habilita/desabilita benefÃ­cio para CLIENTE_APOIADO
  apoioMensalMaxAulas Int? // limite de isenÃ§Ãµes/mÃªs (null = ilimitado)
  apoioObs            String? // observaÃ§Ãµes internas

  agendamentos                        Agendamento[]                        @relation("AgendamentoFeitoPor")
  agendamentosPermanentes             AgendamentoPermanente[]
  participaDeAgendamentos             Agendamento[]                        @relation("JogadoresNoAgendamento")
  agendamentosChurrasqueira           AgendamentoChurrasqueira[]           @relation("UsuarioAgendamentoChurrasqueira")
  agendamentosPermanenteChurrasqueira AgendamentoPermanenteChurrasqueira[] @relation("UsuarioAgendamentoPermanenteChurrasqueira")

  agendamentosCancelados                          Agendamento[]                        @relation("AgendamentoCanceladoPor")
  permanentesCancelamentosCriados                 AgendamentoPermanenteCancelamento[]  @relation("UsuarioCriouCancelamentoPermanente")
  agendamentosTransferidos                        Agendamento[]                        @relation("AgendamentoTransferidoPor")
  agendamentosPermanentesCancelados               AgendamentoPermanente[]              @relation("AgendamentoPermanenteCanceladoPor")
  agendamentosPermanentesTransferidos             AgendamentoPermanente[]              @relation("AgendamentoPermanenteTransferidoPor")
  agendamentosChurrasqueiraCancelados             AgendamentoChurrasqueira[]           @relation("AgendamentoChurrasqueiraCanceladoPor")
  agendamentosChurrasqueiraTransferidos           AgendamentoChurrasqueira[]           @relation("AgendamentoChurrasqueiraTransferidoPor")
  agendamentosPermanenteChurrasqueiraCancelados   AgendamentoPermanenteChurrasqueira[] @relation("AgendamentoPermanenteChurrasqueiraCanceladoPor")
  agendamentosPermanenteChurrasqueiraTransferidos AgendamentoPermanenteChurrasqueira[] @relation("AgendamentoPermanenteChurrasqueiraTransferidoPor")

  permanentesChurrasqueiraCancelamentosCriados AgendamentoPermanenteChurrasqueiraCancelamento[] @relation("UsuarioCriouCancelamentoPermanenteChurrasqueira")

  bloqueiosFeitos BloqueioQuadra[] @relation("UsuarioBloqueios")

  // ðŸ‘‡ NOVO: relaÃ§Ã£o com multas anuladas
  multasAnuladas Agendamento[] @relation("MultaAnuladaPor")

  auditLogs AuditLog[] @relation("UsuarioAuditLogs")

  // ðŸ”’ controle de acesso e marcaÃ§Ãµes de exclusÃ£o
  disabledAt  DateTime? // bloqueia login enquanto pendente
  deletedAt   DateTime? // marca remoÃ§Ã£o lÃ³gica (se usar soft delete)
  deletedById String? // quem concluiu a exclusÃ£o (mantido sem FK)

  // relaÃ§Ãµes com a fila de exclusÃ£o
  deletionQueue      UserDeletionQueue?  @relation("DeletionTargetUser")
  deletionsRequested UserDeletionQueue[] @relation("DeletionRequestedBy")

  // ðŸ‘‡ relaÃ§Ãµes como PROFESSOR nos agendamentos
  agendamentosComoProfessor            Agendamento[]           @relation("ProfessorNosAgendamentos")
  agendamentosPermanentesComoProfessor AgendamentoPermanente[] @relation("ProfessorNosPermanentes")

  // ðŸ‘‡ NOVO: relaÃ§Ã£o inversa â€” agendamentos nos quais o usuÃ¡rio foi o APOIADO isento
  agendamentosIsentosComoApoiado Agendamento[] @relation("ApoiadoNosAgendamentos")

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  permissoesAtendentes PermissoesAtendente[]

  @@index([disabledAt])
  @@index([deletedAt])
}

model Esporte {
  id     String  @id @default(uuid())
  nome   String  @unique
  imagem String?

  quadraEsportes          QuadraEsporte[]
  agendamentos            Agendamento[]
  agendamentosPermanentes AgendamentoPermanente[]

  /// ðŸ‘‡ NOVO: janelas configurÃ¡veis por esporte
  janelasAula EsporteJanelaAula[]
}

/// ðŸ‘‡ NOVO MODEL: Janela de horÃ¡rios para AULA/JOGO por esporte.
model EsporteJanelaAula {
  id String @id @default(uuid())

  esporteId String
  esporte   Esporte @relation(fields: [esporteId], references: [id])

  diaSemana  DiaSemana? // null = regra padrÃ£o para todos os dias
  tipoSessao TipoSessaoProfessor @default(AULA)

  inicioHHMM String // ex.: "07:00"
  fimHHMM    String // ex.: "19:00"

  ativo Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([esporteId, diaSemana, tipoSessao], map: "uniq_janela_esporte_dia_tipo")
  @@index([esporteId, diaSemana, tipoSessao])
}

model Quadra {
  id         String     @id @default(uuid())
  nome       String
  numero     Int
  tipoCamera TipoCamera
  imagem     String?

  quadraEsportes          QuadraEsporte[]
  agendamentos            Agendamento[]
  agendamentosPermanentes AgendamentoPermanente[]

  bloqueios BloqueioQuadra[] @relation("QuadrasNoBloqueio")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model QuadraEsporte {
  quadraId  String
  esporteId String

  quadra  Quadra  @relation(fields: [quadraId], references: [id])
  esporte Esporte @relation(fields: [esporteId], references: [id])

  @@id([quadraId, esporteId])
  @@index([esporteId])
}

model Churrasqueira {
  id         String  @id @default(uuid())
  nome       String
  numero     Int
  imagem     String?
  observacao String?

  agendamentos            AgendamentoChurrasqueira[]
  agendamentosPermanentes AgendamentoPermanenteChurrasqueira[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Agendamento {
  id      String   @id @default(uuid())
  data    DateTime
  horario String

  usuario   Usuario @relation("AgendamentoFeitoPor", fields: [usuarioId], references: [id])
  usuarioId String

  quadra   Quadra @relation(fields: [quadraId], references: [id])
  quadraId String

  esporte   Esporte @relation(fields: [esporteId], references: [id])
  esporteId String

  jogadores Usuario[] @relation("JogadoresNoAgendamento")

  obs String?

  status StatusAgendamento @default(CONFIRMADO)

  canceladoPor   Usuario? @relation("AgendamentoCanceladoPor", fields: [canceladoPorId], references: [id])
  canceladoPorId String?

  transferidoPor   Usuario? @relation("AgendamentoTransferidoPor", fields: [transferidoPorId], references: [id])
  transferidoPorId String?

  // ðŸ‘‡ professor e sessÃ£o
  professorId String?
  professor   Usuario?             @relation("ProfessorNosAgendamentos", fields: [professorId], references: [id])
  tipoSessao  TipoSessaoProfessor? @default(AULA)

  /// ðŸ‘‡ NOVO: isenÃ§Ã£o para CLIENTE_APOIADO
  isencaoApoiado   Boolean  @default(false)
  apoiadoUsuarioId String?
  apoiadoUsuario   Usuario? @relation("ApoiadoNosAgendamentos", fields: [apoiadoUsuarioId], references: [id])

  /// ðŸ‘‡ NOVO: valor efetivamente cobrado (pÃ³s-isencÃ£o/descontos)
  valorQuadraCobrado Decimal? @db.Decimal(10, 2)

  /// Valor de multa (existente; mantido opcional)
  multa Decimal? @db.Decimal(10, 2)

  /// ðŸ‘‡ NOVOS CAMPOS: controle de anulaÃ§Ã£o de multa
  multaAnulada      Boolean   @default(false)
  multaAnuladaEm    DateTime?
  multaAnuladaPorId String?
  multaAnuladaPor   Usuario?  @relation("MultaAnuladaPor", fields: [multaAnuladaPorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([usuarioId])
  @@index([quadraId, data])
  @@index([professorId, tipoSessao, data])
  @@index([apoiadoUsuarioId, data])
  @@index([quadraId, data, horario])
  @@index([data, status])
}

model AgendamentoPermanente {
  id        String    @id @default(uuid())
  diaSemana DiaSemana
  horario   String

  quadra   Quadra @relation(fields: [quadraId], references: [id])
  quadraId String

  usuario   Usuario @relation(fields: [usuarioId], references: [id])
  usuarioId String

  esporte   Esporte @relation(fields: [esporteId], references: [id])
  esporteId String

  dataInicio DateTime?

  status StatusAgendamento @default(CONFIRMADO)

  canceladoPor   Usuario? @relation("AgendamentoPermanenteCanceladoPor", fields: [canceladoPorId], references: [id])
  canceladoPorId String?

  transferidoPor   Usuario? @relation("AgendamentoPermanenteTransferidoPor", fields: [transferidoPorId], references: [id])
  transferidoPorId String?

  // exceÃ§Ãµes por data (cancelar sÃ³ um dia) â€” QUADRA
  cancelamentos AgendamentoPermanenteCancelamento[]

  // professor e sessÃ£o (tambÃ©m nos permanentes)
  professorId String?
  professor   Usuario?             @relation("ProfessorNosPermanentes", fields: [professorId], references: [id])
  tipoSessao  TipoSessaoProfessor? @default(AULA)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([usuarioId])
  @@index([quadraId, diaSemana, horario])
  @@index([professorId, tipoSessao, diaSemana])
  @@index([diaSemana, status])
}

model AgendamentoChurrasqueira {
  id String @id @default(uuid())

  // comum por data (mantÃ©m Turno)
  data  DateTime
  turno Turno

  churrasqueira   Churrasqueira @relation(fields: [churrasqueiraId], references: [id])
  churrasqueiraId String

  usuario   Usuario @relation("UsuarioAgendamentoChurrasqueira", fields: [usuarioId], references: [id])
  usuarioId String

  status StatusAgendamento @default(CONFIRMADO)

  canceladoPor   Usuario? @relation("AgendamentoChurrasqueiraCanceladoPor", fields: [canceladoPorId], references: [id])
  canceladoPorId String?

  transferidoPor   Usuario? @relation("AgendamentoChurrasqueiraTransferidoPor", fields: [transferidoPorId], references: [id])
  transferidoPorId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([usuarioId])
  @@index([churrasqueiraId, data])
  @@index([churrasqueiraId, data, turno])
}

model AgendamentoPermanenteChurrasqueira {
  id         String    @id @default(uuid())
  diaSemana  DiaSemana
  turno      Turno
  dataInicio DateTime?

  churrasqueira   Churrasqueira @relation(fields: [churrasqueiraId], references: [id])
  churrasqueiraId String

  usuario   Usuario @relation("UsuarioAgendamentoPermanenteChurrasqueira", fields: [usuarioId], references: [id])
  usuarioId String

  status StatusAgendamento @default(CONFIRMADO)

  canceladoPor   Usuario? @relation("AgendamentoPermanenteChurrasqueiraCanceladoPor", fields: [canceladoPorId], references: [id])
  canceladoPorId String?

  transferidoPor   Usuario? @relation("AgendamentoPermanenteChurrasqueiraTransferidoPor", fields: [transferidoPorId], references: [id])
  transferidoPorId String?

  // NOVO: exceÃ§Ãµes por data (um dia cancelado na recorrÃªncia) â€” CHURRASQUEIRA
  cancelamentos AgendamentoPermanenteChurrasqueiraCancelamento[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // âœ… remove UNIQUE global, e mantÃ©m sÃ³ um Ã­ndice normal pra performance.
  // O "Ãºnico por slot" vai virar UNIQUE PARCIAL na migration SQL (Postgres).
  @@index([churrasqueiraId, diaSemana, turno], map: "idx_perm_churra_slot")
}

//
// ðŸ”¹ NOVO MODEL: motivos de bloqueio de quadras
//
model MotivoBloqueio {
  id        String  @id @default(uuid())
  nome      String  @unique // ex.: "ManutenÃ§Ã£o", "Torneio"
  descricao String?
  ativo     Boolean @default(true)

  // relaÃ§Ã£o inversa: bloqueios que usam este motivo
  bloqueios BloqueioQuadra[] @relation("MotivoNoBloqueio")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Nova model para bloquear quadras por dia e horÃ¡rio
model BloqueioQuadra {
  id           String   @id @default(uuid())
  dataBloqueio DateTime

  inicioBloqueio String // ex: "09:00"
  fimBloqueio    String // ex: "22:00"

  quadras Quadra[] @relation("QuadrasNoBloqueio")

  bloqueadoPor   Usuario @relation("UsuarioBloqueios", fields: [bloqueadoPorId], references: [id])
  bloqueadoPorId String

  // ðŸ‘‡ NOVO: motivo opcional (palavra-chave cadastrada)
  motivoId String?
  motivo   MotivoBloqueio? @relation("MotivoNoBloqueio", fields: [motivoId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Ã­ndice para buscas por bloqueios em um dia/intervalo
  @@index([dataBloqueio])
  /// Ã­ndice auxiliar por motivo (ex.: relatÃ³rios por motivo)
  @@index([motivoId])
}

// ExceÃ§Ã£o (um dia) â€” QUADRA
model AgendamentoPermanenteCancelamento {
  id                      String   @id @default(uuid())
  agendamentoPermanenteId String
  data                    DateTime
  motivo                  String?
  criadoPorId             String?
  createdAt               DateTime @default(now())

  permanente AgendamentoPermanente @relation(fields: [agendamentoPermanenteId], references: [id], onDelete: Cascade)
  criadoPor  Usuario?              @relation("UsuarioCriouCancelamentoPermanente", fields: [criadoPorId], references: [id])

  @@unique([agendamentoPermanenteId, data])
  @@index([agendamentoPermanenteId, data])
}

// NOVO: ExceÃ§Ã£o (um dia) â€” CHURRASQUEIRA
model AgendamentoPermanenteChurrasqueiraCancelamento {
  id                                   String   @id @default(uuid())
  agendamentoPermanenteChurrasqueiraId String
  data                                 DateTime
  motivo                               String?
  criadoPorId                          String?
  createdAt                            DateTime @default(now())

  permanente AgendamentoPermanenteChurrasqueira @relation(fields: [agendamentoPermanenteChurrasqueiraId], references: [id], onDelete: Cascade)
  criadoPor  Usuario?                           @relation("UsuarioCriouCancelamentoPermanenteChurrasqueira", fields: [criadoPorId], references: [id])

  @@unique([agendamentoPermanenteChurrasqueiraId, data])
  @@index([agendamentoPermanenteChurrasqueiraId, data])
}

model ConfiguracaoSistema {
  id               Int     @id
  valorMultaPadrao Decimal @db.Decimal(10, 2)

  // =========================================================
  // âœ… NOVO: Regra global para "AULA apÃ³s horÃ¡rio" (aula extra)
  // - EditÃ¡vel pelo ADMIN_MASTER
  // - O valor final SEMPRE Ã© salvo em Agendamento.valorQuadraCobrado
  // =========================================================
  aulaExtraAtiva      Boolean @default(true)
  aulaExtraInicioHHMM String  @default("18:00") // corte
  aulaExtraFimHHMM    String  @default("23:00") // [inicio, fim) - padrÃ£o do teu cÃ³digo
  valorAulaExtra      Decimal @default(50.00) @db.Decimal(10, 2)
}

// âœ… NOVO: Config global (singleton) das permissÃµes do ADMIN_ATENDENTE.
// A ideia Ã© ter SEMPRE 1 linha (id=1). O ADMIN_MASTER edita essa lista.
model PermissoesAtendente {
  id Int @id @default(1)

  // lista de "features" liberadas pro atendente
  features AtendenteFeature[] @default([])

  // quem alterou por Ãºltimo (opcional)
  updatedById String?
  updatedBy   Usuario? @relation(fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([updatedById])
}

// =====================
// AUDITORIA
// =====================

enum AuditTargetType {
  USUARIO
  AGENDAMENTO
  AGENDAMENTO_PERMANENTE
  AGENDAMENTO_CHURRASQUEIRA
  AGENDAMENTO_PERMANENTE_CHURRASQUEIRA
  QUADRA
  CHURRASQUEIRA
  SISTEMA
}

model AuditLog {
  id String @id @default(uuid())

  // Quem fez (pode ser null em aÃ§Ãµes anÃ´nimas)
  actorId   String?
  actor     Usuario?     @relation("UsuarioAuditLogs", fields: [actorId], references: [id])
  actorName String? // snapshot do nome no momento do evento
  actorTipo TipoUsuario? // snapshot do tipo no momento do evento

  // O que aconteceu
  event String // ex.: "LOGIN_SUCESSO", "AGENDAMENTO_CREATE", etc.

  // Contra quem/qual recurso
  targetType AuditTargetType
  targetId   String? // id do recurso; pode ser null em eventos gerais

  // Contexto
  ip        String?
  userAgent String?
  metadata  Json?

  createdAt DateTime @default(now())

  @@index([event])
  @@index([actorId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

model UserDeletionQueue {
  id String @id @default(uuid())

  // UsuÃ¡rio alvo (1:1)
  usuarioId String  @unique
  usuario   Usuario @relation("DeletionTargetUser", fields: [usuarioId], references: [id])

  // Quem solicitou (opcional)
  requestedById String?
  requestedBy   Usuario? @relation("DeletionRequestedBy", fields: [requestedById], references: [id])

  status DeletionStatus @default(PENDING)

  // Ãšltima interaÃ§Ã£o para exibir no front
  lastInteractionType InteractionType @default(NONE)
  lastInteractionId   String?
  lastInteractionDate DateTime?

  // Data a partir da qual pode excluir (ex.: lastInteractionDate + 90d)
  eligibleAt DateTime?

  // Auditoria da fila
  requestedAt DateTime  @default(now())
  processedAt DateTime?
  cancelledAt DateTime?
  attempts    Int       @default(0)
  reason      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, eligibleAt])
  @@index([requestedAt])
}
